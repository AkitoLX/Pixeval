                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  using Microsoft.UI.Xaml.Input;
using System;
using System.Threading.Tasks;
using CommunityToolkit.WinUI.UI.Animations;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  using Microsoft.UI.Xaml;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  using Microsoft.UI.Xaml.Media;
using Microsoft.UI.Xaml.Media.Animation;
using Microsoft.UI.Xaml.Navigation;
using Pixeval.Util;
using Pixeval.ViewModel;

namespace Pixeval.Pages
{
    public sealed partial class ImageViewerPage
    {
        private ImageViewerPageViewModel _viewModel = null!;

        public ImageViewerPage()
        {
            InitializeComponent();
        }

        protected override async void OnNavigatedTo(NavigationEventArgs e)
        {
            base.OnNavigatedTo(e);
            _viewModel = (ImageViewerPageViewModel) e.Parameter;
            if (_viewModel.IllustrationViewModel.ThumbnailSource is null)
            {
                _ = _viewModel.IllustrationViewModel.LoadThumbnail().ContinueWith(_ =>
                {
                    DispatcherQueue.TryEnqueue(() => SetSource(_viewModel.IllustrationViewModel.ThumbnailSource!));
                });
            }

            SetSource(await _viewModel.LoadOriginalImage());
        }

        private void IllustrationOriginalImage_OnManipulationDelta(object sender, ManipulationDeltaRoutedEventArgs e)
        {
            var (translationX, translationY) = (IllustrationOriginalImageRenderTransform.TranslateX, IllustrationOriginalImageRenderTransform.TranslateY);
            var (deltaX, deltaY) = (e.Delta.Translation.X, e.Delta.Translation.Y);
            if (GetZoomFactor() > 1)
            {
                IllustrationOriginalImageRenderTransform.TranslateX += deltaX;
                IllustrationOriginalImageRenderTransform.TranslateY += deltaY;
            }
        }

        private void IllustrationOriginalImage_OnDoubleTapped(object sender, DoubleTappedRoutedEventArgs e)
        {
            var point = e.GetPosition(IllustrationOriginalImage);
            IllustrationOriginalImageRenderTransform.CenterX = point.X;
            IllustrationOriginalImageRenderTransform.CenterY = point.Y;
            if (GetZoomFactor() > 1)
            {
                ResetImageScaleStoryboard.Begin();
                ResetImageTranslationStoryboard.Begin();
                if (_tappedScaled)
                {
                    _tappedScaled.Inverse();
                }
            }
            else
            {
                ImageScaledOut200PercentStoryboard.Begin();
                _tappedScaled.Inverse();
            }
        }

        private void ResetImageScaleStoryboard_OnCompleted(object? sender, object e)
        {
            ResetImageScaleStoryboard.Stop();
            IllustrationOriginalImageRenderTransform.ScaleX = 1;
            IllustrationOriginalImageRenderTransform.ScaleY = 1;
        }

        private void ImageScaledOut200PercentStoryboard_OnCompleted(object? sender, object e)
        {
            ImageScaledOut200PercentStoryboard.Stop();
            IllustrationOriginalImageRenderTransform.ScaleX = 2;
            IllustrationOriginalImageRenderTransform.ScaleY = 2;
        }

        private void ResetImageTranslationStoryboard_OnCompleted(object? sender, object e)
        {
            ResetImageTranslationStoryboard.Stop();
            IllustrationOriginalImageRenderTransform.TranslateX = 0;
            IllustrationOriginalImageRenderTransform.TranslateY = 0;
        }

        #region Helper Functions

        private readonly EasingFunctionBase _easingFunction = new ExponentialEase
        {
            EasingMode = EasingMode.EaseOut,
            Exponent = 12
        };

        private bool _tappedScaled;

        private void SetSource(ImageSource imageSource)
        {
            IllustrationOriginalImage.Source = imageSource;
        }

        // use int for an easy-comparison
        private (double, double) GetImageInViewportScaledSize()
        {
            return (IllustrationOriginalImageContainer.Width / GetZoomFactor(), IllustrationOriginalImageContainer.Height / GetZoomFactor());
        }

        private double GetResizedManipulationBound()
        {
            return 100 / GetZoomFactor();
        }

        private double GetZoomFactor()
        {
            return IllustrationOriginalImageRenderTransform.ScaleX;
        }

        #endregion
    }
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      